var documenterSearchIndex = {"docs":
[{"location":"vertical/hbv/#HBV-vertical-concept","page":"HBV","title":"HBV vertical concept","text":"","category":"section"},{"location":"vertical/hbv/","page":"HBV","title":"HBV","text":"Documentation to be added.","category":"page"},{"location":"model/sbm/#wflow_sbm","page":"wflow_sbm","title":"wflow_sbm","text":"","category":"section"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"Wflow_sbm represents a family of hydrological models that derived from the CQflow model (Köhler et al.,2006) that has been applied in various countries, most notably in Central America. The models have the vertical SBM concept in common. The soil part of wflow_sbm is largely based on the Topog_SBM model but has had considerable changes over time. Topog_SBM is specifically designed to simulate fast runoff processes in small catchments while wflow_sbm model can be applied more widely. The main differences are for the vertical concept SBM of wflow_sbm:","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"The unsaturated zone can be split-up in different layers\nThe addition of evapotranspiration losses\nThe addition of a capillary rise","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"The vertical SBM concept is explained in more detail in SBM vertical concept.","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"Topog_SBM uses an element network based on contour lines and trajectories for water routing. Wflow_sbm models differ in how the lateral components:","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"river\nland\nsubsurface  ","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"are solved.","category":"page"},{"location":"model/sbm/#SBM-Kinematic-wave","page":"wflow_sbm","title":"SBM + Kinematic wave","text":"","category":"section"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"For the lateral components of this wflow_sbm model water is routed over a D8 network, and the kinematic wave approach is used for river, overland and lateral subsurface flow. This is described in more detail Kinematic wave.","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"Overview of the different processes and fluxes in the wflow_sbm model:","category":"page"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"(Image: wflow_sbm model)","category":"page"},{"location":"model/sbm/#SBM-Groundwater-flow","page":"wflow_sbm","title":"SBM + Groundwater flow","text":"","category":"section"},{"location":"model/sbm/","page":"wflow_sbm","title":"wflow_sbm","text":"For river and overland flow the kinematic wave approach over a D8 network is used for this wflow_sbm model. For the subsurface domain, an unconfined aquifer with groundwater flow in four directions (adjacent cells) is used. This is described in more detail Groundwater flow.","category":"page"},{"location":"vertical/process/#Vertical-processes","page":"Vertical processes","title":"Vertical processes","text":"","category":"section"},{"location":"vertical/process/#Snow-and-glaciers","page":"Vertical processes","title":"Snow and glaciers","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Snow and glacier processes are derived from the original HBV concept and HBV-light respectively. ","category":"page"},{"location":"vertical/process/#Snow-modelling","page":"Vertical processes","title":"Snow modelling","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"If the air temperature, T_a, is below a user-defined threshold tt (degreeC) precipitation occurs as snowfall, whereas it occurs as rainfall if Ta  tt. A another parameter tti defines how precipitation can occur partly as rain of snowfall (see the figure below). If precipitation occurs as snowfall, it is added to the dry snow component within the snow pack. Otherwise it ends up in the free water reservoir, which represents the liquid water content of the snow pack. Between the two components of the snow pack, interactions take place, either through snow melt (if temperatures are above a threshold tt) or through snow refreezing (if temperatures are below threshold tt.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The respective rates of snow melt and refreezing are:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Q_m = cfmax(T_att) T_a  tt \nQ_r=cfmax  cfr(ttT_a) Ta  tt","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"where Q_m is the rate of snow melt, Q_r is the rate of snow refreezing, and cfmax and cfr are user defined model parameters (the melting factor mm/((degreeC day) and the refreezing factor respectively).","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The fraction of liquid water in the snow pack is at most equal to a user defined fraction, whc, of the water equivalent of the dry snow content. If the liquid water concentration exceeds whc, either through snow melt or incoming rainfall, the surpluss water (rainfall) becomes available for infiltration into the soil:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"    snowwater = snowwater - refreezing  # free water content in snow\n    maxsnowwater = snow * whc  # max water in the snow\n    snowwater = snowwater + snowmelt + rainfall  # add all water and potentially supersaturate the snowpack\n    rainfall = max(snowwater - maxsnowwater, 0.0)  # rain + surpluss snowwater","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"\n (Image: snow hbv) Schematic view of the snow routine","category":"page"},{"location":"vertical/process/#Glacier-modelling","page":"Vertical processes","title":"Glacier modelling","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Glacier processes can be modelled if the snow model is enabled. For the vertical HBV concept snow modelling is not optional. Glacier modelling is very close to snow modelling and considers two main processes: glacier build-up from snow turning into firn/ice (using the HBV-light model) and glacier melt (using a temperature degree-day model).","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The definition of glacier boundaries and initial volume is defined in three parameters. glacierfrac is a parameter that gives the fraction of each grid cell covered by a glacier as a number between zero and one. glacierstore is a state parameter that gives the amount of water (in mm w.e.) within the glaciers at each gridcell. Because the glacier store (glacierstore) cannot be initialized by running the model for a couple of years, a default initial state should be supplied by adding this parameter to the input static file. The required glacier data can be prepared from available glacier datasets.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"First, a fixed fraction of the snowpack on top of the glacier is converted into ice for each timestep and added to the glacierstore using the HBV-light model (Seibert et al.,2017). This fraction g_sifrac typically ranges from 0.001 to 0.006.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Then, when the snowpack on top of the glacier is almost all melted (snow cover < 10 mm), glacier melt is enabled and estimated with a degree-day model. If the air temperature, T_a, is below a certain threshold g_tt (degreeC) precipitation occurs as snowfall, whereas it occurs as rainfall if T_a  g_tt.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"With this the rate of glacier melt in mm is estimated as:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Q_m = g_cfmax(T_a  g_tt)   T_a  g_tt","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"where Q_m is the rate of glacier melt and g_cfmax is the melting factor in mm/(degreeC day). Parameter g_tt can be taken as equal to the snow tt parameter. Values of the melting factor g_cfmax normally varies from one glacier to another and some values are reported in the literature. g_cfmax can also be estimated by multiplying snow cfmaxby a factor between 1 and 2, to take into account the higher albedo of ice compared to snow.","category":"page"},{"location":"vertical/process/#Rainfall-interception","page":"Vertical processes","title":"Rainfall interception","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Both the Gash and Rutter models are available to estimate rainfall interception by the vegetation. The selection of an interception model depends on the simulation timestep.","category":"page"},{"location":"vertical/process/#The-analytical-(Gash)-model","page":"Vertical processes","title":"The analytical (Gash) model","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The analytical model of rainfall interception is based on Rutter’s numerical model. The simplifications that introduced allow the model to be applied on a daily basis, although a storm-based approach will yield better results in situations with more than one storm per day. The amount of water needed to completely saturate the canopy is defined as:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"P=frac-overlineRSoverlineE_wlnleft1-fracoverlineE_woverlineR(1-p-p_t)^-1right","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"where overlineR is the average precipitation intensity on a saturated canopy and overlineE_w the average evaporation from the wet canopy and with the vegetation parameters S, p and p_t as defined previously. The model uses a series of expressions to calculate the interception loss during different phases of a storm. An analytical integration of the total evaporation and rainfall under saturated canopy conditions is then done for each storm to determine average values of overlineE_w and overlineR. The total evaporation from the canopy (the total interception loss) is calculated as the sum of the components listed in the table below. Interception losses from the stems are calculated for days with Pgeq S_tp_t. p_t and S_t are small and neglected.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Table: Formulation of the components of interception loss according to Gash:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Components Interception loss\nFor m small storms (P_gP_g) (1-p-p_t)sum_j=1^mP_gj\nWetting up the canopy in n large storms (P_ggeqP_g) n(1-p-p_t)P_g-nS\nEvaporation from saturated canopy during rainfall overlineEoverlineRsum_j=1^n(P_gj-P_g)\nEvaporation after rainfall ceases for n large storms nS\nEvaporation from trunks in q storms that fill the trunk storage qS_t\nEvaporation from  trunks in m+n-q storms that do not fill the trunk storage p_tsum_j=1^m+n-qP_gj","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"In applying the analytical model, saturated conditions are assumed to occur when the hourly rainfall exceeds a certain threshold. Often a threshold of 0.5 mm/hr is used. overlineR is calculated for all hours when the rainfall exceeds the threshold to give an estimate of the mean rainfall rate onto a saturated canopy.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Gash (1979) has shown that in a regression of interception loss on rainfall (on a storm basis) the regression coefficient should equal to overlineE_woverlineR. Assuming that neither overlineE_w nor overlineR vary considerably in time, overlineE_w can be estimated in this way from overlineR in the absence of above-canopy climatic observations. Values derived in this way generally tend to be (much) higher than those calculated with the penman-monteith equation.","category":"page"},{"location":"vertical/process/#The-modified-rutter-model","page":"Vertical processes","title":"The modified rutter model","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"For subdaily timesteps the interception is caclulated using a simplification of the Rutter model. The simplified model is solved explicitly and does not take drainage from the canopy into account.","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Wflow.rainfall_interception_modrut","category":"page"},{"location":"vertical/process/#Wflow.rainfall_interception_modrut","page":"Vertical processes","title":"Wflow.rainfall_interception_modrut","text":"rainfall_interception_modrut(precipitation, potential_evaporation, canopystorage, canopygapfraction, cmax)\n\nInterception according to a modified Rutter model. The model is solved explicitly and there is no drainage below cmax.\n\n\n\n\n\n","category":"function"},{"location":"vertical/process/#Interception-parameters-from-LAI","page":"Vertical processes","title":"Interception parameters from LAI","text":"","category":"section"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The SBM concept can determine the interception parameters from leaf area index (LAI) climatology. In order to switch this on you must define this cyclic parameter in the TOML file, the parameter is read from path_static, as follows:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"[input] \npath_forcing = \"data/forcing-moselle.nc\" \npath_static = \"data/staticmaps-moselle.nc\"\n\ncyclic = [\"vertical.leaf_area_index\"]","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Furtermore these additional parameters are required:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Specific leaf storage  (sl [mm])\nStorage woody part of vegetation (swood [mm])\nExtinction coefficient (kext [-])","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"Here it is assumed that cmax [mm] (leaves) (canopy storage capacity for the leaves only) relates linearly with LAI (c.f. Van Dijk and Bruijnzeel 2001). This done via the sl. sl can be determined through a lookup table with land cover based on literature (Pitman 1986, Lui 1998). Next the cmax (leaves) is determined using:","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"\n    cmax(leaves)  = sl  LAI","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"To get to total storage (cmax) the woody part of the vegetation also needs to be added. As for sl, the storage of the woody part swood can also be related to land cover (lookup table).","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The canopy gap fraction is determined using the extinction coefficient kext (van Dijk and Bruijnzeel 2001):","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"    canopygapfraction = exp(-kext  LAI)","category":"page"},{"location":"vertical/process/","page":"Vertical processes","title":"Vertical processes","text":"The extinction coefficient kext can be related to land cover.","category":"page"},{"location":"quick-start/#Quick-start","page":"Quick start","title":"Quick start","text":"","category":"section"},{"location":"quick-start/#Installation","page":"Quick start","title":"Installation","text":"","category":"section"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"This is a Julia package, that can be installed using Julia's built-in package manager, Pkg. Wflow is currently still unregistered, so the full URL is needed when adding the package, add Wflow does not yet work, but add https://github.com/Deltares/Wflow.jl does. In the rest of this section will provide more detailed instructions, such that new Julia users can also install Wflow. If you already know you can go ahead to the next section.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"First download and install the current stable release of Julia. Please see platform specific instructions for further installation instructions and if you have trouble installing Julia.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"If you are new to Julia, it may be a good idea to check out the Getting Started section of the Julia Manual. Links to other learning resources can be found at julialang.org/learning.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Start an interactive session (also known as a read-eval-print loop or \"REPL\") by double-clicking the Julia executable or running julia from the command line, in case you have chosen to add it to your path. The default prompt will appear, in which Julia code can be entered and run.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"julia> 1 + 2\n3","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Enter the Pkg REPL by pressing ] from the Julia REPL. To get back to the Julia REPL, press backspace or ^C. Just like in the Julia REPL, you can type ? to get a help message, this will list the available commands. To get more information on a specific command type ? followed by the command.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"pkg> ?\n\npkg> ?add","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"If you go back to the Julia REPL, note that the same works, and is a convenient way to consult documentation for specific functions or types, or other objects.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"help?> cos","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Now go back to the Pkg REPL and install Wflow using:","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"pkg> add https://github.com/Deltares/Wflow.jl","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"This can take a while, especially the first time, since compatible dependencies are also automatically looked up and installed from the Pkg General registry. This command will track the master branch, and will update to the latest commit on that branch when you run update, or simply up, in the Pkg REPL. This will install Wflow in you home directory under .julia/packages/Wflow. Note that packages installed under packages by add are supposed to never be altered in that location, for Pkg and it's automatic dependency handling to work well. If you want to make any changes to any of the files in the Wflow directory, you need to do a development install. This can be done using:","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"pkg> dev https://github.com/Deltares/Wflow.jl","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"This will clone the git repository, put it under your home directory in .julia/dev/Wflow, and add the Wflow package to your project environment. Note that to receive updates, you have to pull in the latest changes yourself using git pull.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Finally, go back the Julia REPL and try to load Wflow:","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"julia> using Wflow","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"The first time this will take longer as any package that is new or changed needs to be precompiled first, to allow faster loading on subsequent uses.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"You have now succesfully installed Julia and Wflow. Before ending this section, we still want to recommend a few tools that can make using and developing Julia code easier.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"The first is Revise.jl. This package allows you to modify code and use the changes without restarting Julia. Install it with add Revise from the Pkg REPL. Then create a file called .julia/config/startup.jl, and put using Revise there. This will load Revise everytime you start a Julia session.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"There is a section on editors and IDEs for Julia on https://julialang.org/, scroll down to see it. We use and recommend Microsoft's free and open source Visual Studio Code. When combined with the Julia extension it provides a powerful and interactive development experience.","category":"page"},{"location":"quick-start/#Usage","page":"Quick start","title":"Usage","text":"","category":"section"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"To run a simulation, first the required static and dynamic input data should be prepared in NetCDF files. Next, we use a TOML configuration file, to fully specify a model simulation. This includes the model type, the start- and endtime, the path to the forcing NetCDF files, as well as the mapping of parameters in the model to names in the NetCDF file. See the section Config and TOML for more details.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"As an example, we will run the Moselle example SBM model, of which the configuration file can be seen here: sbm_config.toml. First we share some code that will download the required files to your current working directory:","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"# urls to TOML and NetCDF of the Moselle example model\nstaticmaps = \"https://github.com/visr/wflow-artifacts/releases/download/v0.2.0/staticmaps.nc\"\nforcing = \"https://github.com/visr/wflow-artifacts/releases/download/v0.2.0/forcing-2000.nc\"\ntoml_url = \"https://raw.githubusercontent.com/Deltares/Wflow.jl/use/test/sbm_config.toml\"\n\n# create a \"data\" directory in the current directory\ndatadir = joinpath(@__DIR__, \"data\")\nmkpath(datadir)\ntoml_path = joinpath(@__DIR__, \"sbm_config.toml\")\n\n# download resources to current and data dirs\ndownload(staticmaps, joinpath(datadir, \"staticmaps-moselle.nc\"))\ndownload(forcing, joinpath(datadir, \"forcing-moselle.nc\"))\ndownload(toml_url, toml_path)","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Now that we have our files in place, running a simulation is as simple as calling this function:","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Wflow.run_simulation","category":"page"},{"location":"quick-start/#Wflow.run_simulation","page":"Quick start","title":"Wflow.run_simulation","text":"run_simulation(tomlpath::String)\nrun_simulation(config::Config)\nrun_simulation(model::Model)\n\nRun an entire simulation starting either from a path to a TOML settings file, a prepared Config object, or an initialized Model object. This allows more flexibility if you want to for example modify a Config before initializing the Model.\n\n\n\n\n\n","category":"function"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"As you can see, there are three different methods for this function. We will first make use of the first one, where a path to a TOML file is passed as a String.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"using Wflow\nWflow.run_simulation(toml_path)","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"This will parse the TOML file to create a Wflow.Config, use that to initialize a Wflow.Model, and finally run the Wflow.Model for the specified duration.","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"Wflow.Config\nWflow.Model","category":"page"},{"location":"quick-start/#Wflow.Config","page":"Quick start","title":"Wflow.Config","text":"Config(path::AbstractString)\nConfig(dict::AbstractDict)\nConfig(dict::Dict{String,Any}, path::Union{String,Nothing})\n\nStruct that contains the parsed TOML configuration, as well as a reference to the TOML path, if it exists. It behaves largely like a distionary, but it overloads getproperty and setproperty to support syntax like config.model.reinit = false.\n\n\n\n\n\n","category":"type"},{"location":"quick-start/#Wflow.Model","page":"Quick start","title":"Wflow.Model","text":"Model{N,L,V,R,W}\n\nComposite type that represents all different aspects of a Wflow Model, such as the network, parameters, clock, configuration and input and output.\n\n\n\n\n\n","category":"type"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"If you want to try out several different settings, without having to modify the TOML file every time, you can create a Wflow.Config first, modify some settings, and then start the simulation:","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"using Dates\nconfig = Wflow.Config(toml_path)\nconfig.endtime = DateTime(\"2000-01-03T00:00:00\")\nWflow.run_simulation(config)","category":"page"},{"location":"quick-start/","page":"Quick start","title":"Quick start","text":"For even more control, you can initialize the model object yourself, and modify it directly, or run a custom simulation loop. See the Wflow.run_simulation source for some inspiration.","category":"page"},{"location":"vertical/sbm/#SBM-vertical-concept","page":"SBM","title":"SBM vertical concept","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The SBM vertical concept has its roots in the Topog_SBM model but has had considerable changes over time. The main differences are:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The unsaturated zone can be split-up in different layers\nThe addition of evapotranspiration losses\nThe addition of a capillary rise","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The sections below describe the working of the SBM vertical concept in more detail.","category":"page"},{"location":"vertical/sbm/#Snow","page":"SBM","title":"Snow","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Snow modelling is enabled by specifying the following in the TOML file:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"[model]\nsnow = true","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The snow model is described in Snow modelling","category":"page"},{"location":"vertical/sbm/#Soil","page":"SBM","title":"Soil","text":"","category":"section"},{"location":"vertical/sbm/#Infiltration","page":"SBM","title":"Infiltration","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"If the surface is (partly) saturated the throughfall and stemflow that falls onto the saturated area is added to the river runoff component (based on fraction rivers, riverfrac) and to the overland runoff component (based on open water fraction (waterfrac) minus riverfrac). Infiltration of the remaining water is determined as follows:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The soil infiltration capacity can be adjusted in case the soil is frozen, this is optional and can be set in the TOML file as follows:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"[model]\n# Enable iterations of the kinematic wave\nsoilinfreduction = true ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The remaining storage capacity of the unsaturated store is determined.  The infiltrating water is split in two parts, the part that falls on compacted areas and the part that falls on non-compacted areas. The maximum amount of water that can infiltrate in these areas is calculated by taking the minimum of the maximum infiltration rate (infiltcapsoil for non-compacted areas and infiltcappath for compacted areas) and the water on these areas. The water that can actual infiltrate is calculated by taking the minimum of the total maximum infiltration rate (compacted and non-compacted areas) and the remaining storage capacity.","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Infiltration excess occurs when the infiltration capacity is smaller then the throughfall and stemflow rate. This amount of water (infiltexcess) becomes overland flow (infiltration excess overland flow). Saturation excess occurs when the (upper) soil becomes saturated and water cannot infiltrate anymore. This amount of water (excesswater and exfiltwater) becomes overland flow (saturation excess overland flow).","category":"page"},{"location":"vertical/sbm/#The-SBM-soil-water-accounting-scheme","page":"SBM","title":"The SBM soil water accounting scheme","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"A detailed description of the Topog_SBM model has been given by Vertessy (1999). Briefly: the soil is considered as a bucket with a certain depth (z_t), divided into a saturated store (S) and an unsaturated store (U), the magnitudes of which are expressed in units of depth. The top of the S store forms a pseudo-water table at depth z_i such that the value of S at any time is given by:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    S=(z_t-z_i)(theta_s-theta_r)","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"where theta_s and theta_r are the saturated and residual soil water contents, respectively. ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The unsaturated store (U) is subdivided into storage (U_s) and deficit (U_d) which are again expressed in units of depth:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    U_d=(theta_s-theta_r)z_i-U\n    U_s=U-U_d","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The saturation deficit (S_d) for the soil profile as a whole is defined as: ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    S_d=(theta_s-theta_r)z_t-S","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"All infiltrating water that enters the U store first. The unsaturated layer can be split-up in different layers, by providing the thickness [mm] of the layers in the TOML file. The following example specifies three layers (from top to bottom) of 100, 300 and 800 mm: ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"[model]\nthicknesslayers = [100, 300, 800]","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The code checks for each grid cell the specified layers against the soilthickness, and adds or removes (partly) layer(s) based on the soilthickness.","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Assuming a unit head gradient, the transfer of water (st) from a U store layer is controlled by the saturated hydraulic conductivity K_sat at depth z (bottom layer) or :math:z_{i}, the effective saturation degree of the layer, and a Brooks-Corey power coefficient (parameter c) based on the pore size distribution index lambda (Brooks and Corey (1964)):","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    st=K_mathitsatleft(fractheta-theta_rtheta_s-theta_rright)^c\n    c=frac2+3lambdalambda","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"When the unsaturated layer is not split-up into different layers, it is possible to use the original Topog_SBM vertical transfer formulation, by specifying in the TOML file:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":" [model]\n    transfermethod = true","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The transfer of water from the U store to the S store (st) is in that case controlled by the saturated hydraulic conductivity K_sat at depth z_i and the ratio between U and S_d: ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    st=K_mathitsatfracU_sS_d","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Saturated conductivity (K_sat) declines with soil depth (z) in the model according to: ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    K_sat=K_0e^(-fz)","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"where K_0 is the saturated conductivity at the soil surface and f is a scaling parameter [mm^-1]. The scaling parameter :math:f is defined by:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"f=fractheta_s-theta_rM ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"with theta_s and theta_r as defined previously and M [mm] representing a model parameter.","category":"page"},{"location":"vertical/sbm/#Transpiration-and-soil-evaporation","page":"SBM","title":"Transpiration and soil evaporation","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The potential eveporation left over after interception and open water evaporation (rivers and water bodies) is split in potential soil evaporation and potential transpiration based on the canopy gap fraction (assumed to be identical to the amount of bare soil).","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The potential eveporation left over after interception and open water evaporation (rivers and water bodies) is split in potential soil evaporation and potential transpiration based on the canopy gap fraction (assumed to be identical to the amount of bare soil).","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"For the case of one single soil layer, soil evaporation is scaled according to:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"soilevapunsat = potsoilevap * min(1.0, saturationdeficit / sbm.soilwatercapacity[i])","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"As such, evaporation will be potential if the soil is fully wetted and it decreases linear with increasing soil moisture deficit.","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"For more than one soil layer, soil evaporation is only provided from the upper soil layer (often 100 mm) and soil evaporation is split in evaporation from the unsaturated store and evaporation from the saturated store. First water is evaporated water from the unsaturated store. Then the remaining potential soil evaporation can be used for evaporation from the saturated store. This is only possible, when the water table is present in the upper soil layer (very wet conditions). Both the evaporation from the unsaturated store and the evaporation from the saturated store are limited by the minimum of the remaining potential soil evaporation and the available water in the unsaturated/saturated zone of the upper soil layer. Also for multiple soil layers, the evaporation (both unsaturated and saturated) decreases linearly with decreasing water availability.","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The original Topog_SBM model does not include transpiration or a notion of capillary rise. In SBM transpiration is first taken from the S store if the roots reach the water table z_i. If the S store cannot satisfy the demand the U store is used next. First the number of wet roots is determined (going from 1 to 0) using a sigmoid function as follows:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    wetroots = 10(10 + e^-rootdistpar (zi - rootindepth))","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Here the sharpness parameter rootdistpar (by default a large negative value, -500.0) determines if there is a stepwise output or a more gradual output (default is stepwise). zi [mm] is the level of the water table in the grid cell below the surface, rootindepth [mm] is the maximum depth of the roots below the surface. For all values of zi smaller that rootindepth a value of 1 is returned if they are equal a value of 0.5 is returned if zi is larger than the rootindepth a value of 0 is returned. The returned wetroots fraction is multiplied by the potential evaporation (and limited by the available water in saturated zone) to get the transpiration from the saturated part of the soil:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    # transpiration from saturated store\n    wetroots = scurve(sbm.zi[i], a = rootingdepth, c = sbm.rootdistpar[i])\n    actevapsat = min(pottrans * wetroots, satwaterdepth)\n    satwaterdepth = satwaterdepth - actevapsat\n    restpottrans = pottrans - actevapsat","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Next the remaining potential evaporation is used to extract water from the unsaturated store. The fraction of roots (availcap) that cover the unsaturated zone for each soil layer is used to calculate the potential root water extraction rate (maxextr):","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"maxextr = availcap * ustorelayerdepth","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"When whole_ust_available is set to true in the TOML file as follows, the complete unsaturated storage is available for transpiration:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"[model]\nwhole_ust_available = true","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Next, the Feddes root water uptake reduction model (Feddes et al. (1978)) is used to calculate a reduction coefficient as a function of soil water pressure. Soil water pressure is calculated following Brooks and Corey (1964):","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    frac(theta-theta_r)(theta_s-theta_r) =  Bigglbraceleft(frach_bhright)^lambda h  h_b atop 1  h leq h_b","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"where h is the pressure head (cm), h_b is the air entry pressure head, and theta, theta_s, theta_r and lambda as previously defined.","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Feddes (1978) described a transpiration reduction-curve for the reduction coefficient alpha, as a function of h.","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Below, the function used in SBM, that calculates actual transpiration from the unsaturated zone layer(s).","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Wflow.acttransp_unsat_sbm(rootingdepth, ustorelayerdepth, sumlayer, restpotevap, sum_actevapustore, c, usl, θₛ, θᵣ, hb, ust::Bool = false)","category":"page"},{"location":"vertical/sbm/#Wflow.acttransp_unsat_sbm","page":"SBM","title":"Wflow.acttransp_unsat_sbm","text":"acttransp_unsat_sbm(rootingdepth, ustorelayerdepth, sumlayer, restpotevap, sum_actevapustore, c, usl, θₛ, θᵣ, hb, ust::Bool = false)\n\nCompute actual transpiration for unsaturated zone. If ust is true, the whole unsaturated store is available for transpiration.\n\nArguments\n\nrootingdepth\nustorelayerdepth\nsumlayer (depth (z) of upper boundary unsaturated layer)\nrestpotevap (remaining evaporation)\nsum_actevapustore (cumulative actual transpiration (more than one unsaturated layers))\nc (Brooks-Corey coefficient)\nusl (thickness of unsaturated zone)\nθₛ\nθᵣ\nhb (air entry pressure)\nust\n\nOutput\n\nustorelayerdepth\nsum_actevapustore\nrestpotevap\n\n\n\n\n\n","category":"function"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"Capillary rise is determined using the following approach: first K_sat is determined at the water table z_i; next a potential capillary rise is determined from the minimum of the K_sat, the actual transpiration taken from the U store, the available water in the S store and the deficit of the U store. Finally the potential rise is scaled using the distance between the roots and the water table using:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"CSF=CS(CS+z_i-RT)","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"in which CSF is the scaling factor to multiply the potential rise with, CS is a model parameter (default = 100) and RT the rooting depth. If the roots reach the water table (RT  z_i) CS is set to zero thus setting the capillary rise to zero.","category":"page"},{"location":"vertical/sbm/#Leakage","page":"SBM","title":"Leakage","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"If the maxleakage parameter is set > 0, water is lost from the saturated zone and runs out of the model.","category":"page"},{"location":"vertical/sbm/#Soil-temperature","page":"SBM","title":"Soil temperature","text":"","category":"section"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"The near surface soil temperature is modelled using a simple equation (Wigmosta et al., 2009):","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"T_s^t = T_s^t-1 + w  (T_a - T_s^t-1)  ","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"where T_s^t is the near-surface soil temperature at time t, T_a is air temperature and w is a weighting coefficient determined through calibration (default is 0.1125 for daily timesteps).","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"A reduction factor (cf_soil, default is 0.038) is applied to the maximum infiltration rate (infiltcapsoil and infiltcappath), when the following model settings are specified in the TOML file:","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"[model]\nsoilinfreduction = true\nsnow = true","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"A S-curve is used to make a smooth transition (a c-factor (c) of 8.0 is used):","category":"page"},{"location":"vertical/sbm/","page":"SBM","title":"SBM","text":"    b = frac10(10 - cf_soil)\n    soilinfredu = frac10b + exp(-c (T_s - a)) + cf_soil\n    a = 00\n    c = 80","category":"page"},{"location":"model/hbv/#HBV-model","page":"wflow_hbv","title":"HBV model","text":"","category":"section"},{"location":"model/hbv/","page":"wflow_hbv","title":"wflow_hbv","text":"The Hydrologiska Byrans Vattenbalansavdelning (HBV) model was introduced back in 1972 by the Swedisch Meteological and Hydrological Institute (SMHI).  The HBV model is mainly used for runoff simulation and hydrological forecasting. The model is particularly useful for catchments where snow fall and snow melt are dominant factors, but application of the model is by no means restricted to these type of catchments.","category":"page"},{"location":"model/hbv/","page":"wflow_hbv","title":"wflow_hbv","text":"The model is based on the HBV-96 model. However, the hydrological routing represent in HBV by a triangular function controlled by the MAXBAS parameter has been removed. Instead, the kinematic wave function is used to route the water downstream. All runoff that is generated in a cell in one of the HBV reservoirs is added to the kinematic wave reservoir at the end of a timestep. There is no connection between the different HBV cells within the model.","category":"page"},{"location":"model/hbv/","page":"wflow_hbv","title":"wflow_hbv","text":"A catchment is divided into a number of grid cells. For each of the cells individually, daily runoff is computed through application of the HBV-96 of the HBV model. The use of the grid cells offers the possibility to turn the HBV modelling concept, which is originally lumped, into a distributed model.","category":"page"},{"location":"model/hbv/","page":"wflow_hbv","title":"wflow_hbv","text":"The vertical HBV concept of the HBV model is explained in more detail in HBV vertical concept.","category":"page"},{"location":"model/hbv/","page":"wflow_hbv","title":"wflow_hbv","text":"The routing for river and overland flow is described in Kinematic wave.","category":"page"},{"location":"devdocs/#Developer-documentation","page":"Developer documentation","title":"Developer documentation","text":"","category":"section"},{"location":"devdocs/","page":"Developer documentation","title":"Developer documentation","text":"Documentation to be added.","category":"page"},{"location":"lateral/gwf/#Groundwater-flow","page":"Groundwater flow","title":"Groundwater flow","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Single layer groundwater flow is defined in the struct GroundwaterFlow, which contains the following fields:","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"aquifer\nconnectivity\nconstanthead\nboundaries","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Base.@kwdef struct GroundwaterFlow\n    aquifer::A where A <: Aquifer\n    connectivity::Connectivity\n    constanthead::ConstantHead\n    boundaries::Vector{B} where B <: AquiferBoundaryCondition\nend","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"The fields of struct GroundwaterFlow are described in more detail below.","category":"page"},{"location":"lateral/gwf/#Aquifer-types","page":"Groundwater flow","title":"Aquifer types","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Groundwater flow contains the Abstract type Aquifer, that can be either a confined (ConfinedAquifer) or unconfined (UnconfinedAquifer) aquifer. Groundwater flow is solved forward in time and central in space.","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Wflow.Aquifer","category":"page"},{"location":"lateral/gwf/#Wflow.Aquifer","page":"Groundwater flow","title":"Wflow.Aquifer","text":"Aquifer\n\nAbstract type representing an aquifer, either confined or unconfined.\n\nThe vertically averaged governing equation of an unconfined, inhomogeneous and isotropic aquifer in one dimension can be written as:\n\nS * ∂ϕ / ∂t = ∂ / ∂x * (kH * ∂ϕ / ∂x) + Q\n\nwith:\n\nS: storativity (or storage coefficient)\nϕ: hydraulic head (groundwater level)\nt: time\nk: conductivity\nH: H the (saturated) aquifer height: groundwater level - aquifer bottom elevation\nη: elevation of aquifer bottom\nQ: fluxes from boundary conditions (e.g. recharge or abstraction)\n\nThe simplest finite difference formulation is forward in time, central in space, and can be written as:\n\nSᵢ * (ϕᵢᵗ⁺¹ - ϕᵢᵗ) / Δt = -Cᵢ₋₁ * (ϕᵢ₋₁ - ϕᵢ) -Cᵢ * (ϕᵢ₊₁ - ϕᵢ) + Qᵢ\n\nwith:\n\nᵢ as cell index\nᵗ as time index\nΔt as step size\nCᵢ₋₁ as the intercell conductance between cell i-1 and i\nCᵢ as the intercell conductance between cell i and i+1\n\nConductance is defined as:\n\nC = kH * w / l\n\nwith:\n\nw the width of the cell to cell connection\nl the length of the cell to cell connection\n\nk and H may both vary in space; intercell conductance is therefore an average using the properties of two cells. See the documentation below.\n\nThere is only one unknown, ϕᵢᵗ⁺¹. Reshuffling terms: \n\nϕᵢᵗ⁺¹ = ϕᵢᵗ + (Cᵢ₋₁ * (ϕᵢ - ϕᵢ₋₁) + Cᵢ * (ϕᵢ₊₁ - ϕᵢ) + Qᵢ) * Δt / Sᵢ\n\nThis can be generalized to two dimensions, for both regular and irregular cell connectivity.\n\nSee this paper for more details:      Chu, W. S., & Willis, R. (1984). An explicit finite difference model for      unconfined aquifers. Groundwater, 22(6), 728-734. \n\nBoundary conditions can be classified into three categories:\n\nspecified head (Dirichlet)\nspecified flux (Neumann)\nhead-dependent flux (Robin)\n\nNeumann and Robin conditions are implemented by adding to or subtracting from a net (lumped) cell flux. Dirichlet conditions are special cased, since they cannot (easily) be implemented via the flux, but the head is set directly instead.\n\n\n\n\n\n","category":"type"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Wflow.ConfinedAquifer","category":"page"},{"location":"lateral/gwf/#Wflow.ConfinedAquifer","page":"Groundwater flow","title":"Wflow.ConfinedAquifer","text":"ConfinedAquifer{T} <: Aquifer\n\nConfined aquifers are overlain by a poorly permeable confining layer (e.g. clay). No air can get in to fill the pore space so that the aquifer always remains fully saturated. For a confined aquifer, water will always flow along the complete height over the aquifer and transmissivity kH (m d⁻¹) is a constant.\n\nSpecific storage is the amount of water an aquifer releases per unit change in hydraulic head, per unit volume of aquifer, as the aquifer and the groundwater itself is compressed. Its value is much smaller than specific yield, between 1E-5 (stiff) and 0.01 (weak).\n\nNOTA BENE: specific storage is per m of aquifer (conf. specific weight). Storativity or (storage coefficient) is for the entire aquifer (conf. transmissivity).\n\n\n\n\n\n","category":"type"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Wflow.UnconfinedAquifer","category":"page"},{"location":"lateral/gwf/#Wflow.UnconfinedAquifer","page":"Groundwater flow","title":"Wflow.UnconfinedAquifer","text":"UnconfinedAquifer{T} <: Aquifer\n\nThe upper boundary of an unconfined aquifer is the water table (the phreatic surface).\n\nSpecific yield (or drainable porosity) represents the volumetric fraction the aquifer will yield when all water drains and the pore volume is filled by air instead. Specific yield will vary roughly between 0.05 (clay) and 0.45 (peat) (Johnson, 1967).\n\n\n\n\n\n","category":"type"},{"location":"lateral/gwf/#Connectivity","page":"Groundwater flow","title":"Connectivity","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"The connectivity between cells is defined as follows.","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Wflow.Connectivity","category":"page"},{"location":"lateral/gwf/#Wflow.Connectivity","page":"Groundwater flow","title":"Wflow.Connectivity","text":"Connectivity{T}\n\nStores connection data between cells. Connections are stored in a compressed sparse column (CSC) adjacency matrix: only non-zero values are stored. Primarily, this consist of two vectors:\n\nthe row value vector holds the cell indices of neighbors\nthe column pointers marks the start and end index of the row value vector\n\nThis matrix is square: n = m = ncell. nconnection is equal to nnz (the number of non-zero values).\n\nncell: the number of (active) cells in the simulation\nnconnection: the number of connections between cells\nlength1: for every connection, the length in the first cell, size nconnection\nlength2: for every connection, the length in the second cell, size nconnection\nwidth: width for every connection, (approx.) perpendicular to length1 and length2, size nconnection\ncolptr: CSC column pointer (size ncell + 1)\nrowval: CSC row value (size nconnection)\n\n\n\n\n\n","category":"type"},{"location":"lateral/gwf/#Constant-head","page":"Groundwater flow","title":"Constant head","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Dirichlet boundary conditions can be specified through the field constanthead.","category":"page"},{"location":"lateral/gwf/#Aquifer-boundary-conditions","page":"Groundwater flow","title":"Aquifer boundary conditions","text":"","category":"section"},{"location":"lateral/gwf/#River","page":"Groundwater flow","title":"River","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"The flux between river and aquifer is calculated using Darcy's law following the approach in MODFLOW:","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"    Q_riv =  BigglbraceC_i textmin(h_riv - B_riv h_riv - phi) h_riv  phi atop C_e (h_riv - phi)  h_riv leq phi","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"where Q_riv is the exchange flux from river to aquifer [L^3 T^-1], C_i [L^2 T^-1] is the river bed infiltration conductance, C_e [L^2 T^-1] is the river bed exfiltration conductance, B_riv the bottom of the river bed [L], h_riv is the rive stage [L] and phi is the hydraulic head in the river cell [L].","category":"page"},{"location":"lateral/gwf/#Drainage","page":"Groundwater flow","title":"Drainage","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"The flux from drains to the aquifer is calculated as follows:","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Q_drain = C_drain textmin(0 h_drain - phi)","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"where Q_drain is the exchange flux from drains to aquifer [L^3 T^-1], C_drain [L^2 T^-1] is the drain conductance, h_drain is the drain elevation [L] and phi is the hydraulic head in the cell with drainage [L].","category":"page"},{"location":"lateral/gwf/#Recharge","page":"Groundwater flow","title":"Recharge","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"The recharge flux Q_r to the aquifer is calculated as follows:","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Q_r = R  A","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"with R the recharge rate [L T^-1] and A the area [L^2 ] of the aquifer cell.","category":"page"},{"location":"lateral/gwf/#Head-boundary","page":"Groundwater flow","title":"Head boundary","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"This boundary is a fixed head with time outside of the model domain, and is generally used to avoid an unneccessarily extension of the model domain to the location of the fixed boundary. The flux from the boundary Q_hb [L^3 T^-1] is calculated as follows:","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"Q_hb = C_hb (phi_hb - phi)","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"with C_hb the conductance of the head boundary [L^2 T^-1], phi_hb the head [L] of the head boundary and  phi the head of the aquifer cell.","category":"page"},{"location":"lateral/gwf/#Well-boundary","page":"Groundwater flow","title":"Well boundary","text":"","category":"section"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"A volumetric well rate [L^3 T^-1] can be specified as a boundary condition.","category":"page"},{"location":"lateral/gwf/","page":"Groundwater flow","title":"Groundwater flow","text":"note: Note\nFor an unconfined aquifer the boundary fluxes are checked, in case of a dry aquifer cell a negative flux is not allowed.","category":"page"},{"location":"lateral/kinwave/#Kinematic-wave","page":"Kinematic wave","title":"Kinematic wave","text":"","category":"section"},{"location":"lateral/kinwave/#Surface-routing","page":"Kinematic wave","title":"Surface routing","text":"","category":"section"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"The main flow routing scheme available in Wflow.jl is the kinematic wave approach for channel and overland flow, assuming that the topography controls water flow mostly. The kinemative wave equations are (Chow, 1988): dfracdQdx + dfracdAdt = q and A = alpha Q^beta. These equations can then be combined as a function of streamflow only:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"    dfracdQdx + alpha beta Q^beta - 1 dfracdQdt = q","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"where Q is the surface runoff in the kinematic wave [m^3/s], x is the length of the runoff pathway [m], A is the cross-section area of the runoff pathway [m^2], t is the integration timestep [s] and alpha and beta are coefficients.","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"These equations are solved with a nonlinear scheme using Newton’s method and can also be iterated depending on the  model space and time resolution. By default, the iterations are performed until a stable solution is reached (epsilon  10^-12). For larger models, the number of iterations can also be fixed for to a specific sub-timestep (in seconds) for both overland and channel flows to improve simulation time. To enable (fixed or not) iterations of the kinematic wave the following lines can be inserted in the TOML file of the model:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"[model]\n# Enable iterations of the kinematic wave\nkin_wave_iteration = true ","category":"page"},{"location":"lateral/kinwave/#Subsurface-flow-routing","page":"Kinematic wave","title":"Subsurface flow routing","text":"","category":"section"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"In the SBM model the kinematic wave approach is used to route subsurface flow laterally. The saturated store S can be drained laterally by saturated downslope subsurface flow per unit width of slope w [mm] according to:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"    q=fracK_0mathittan(beta)f(e^(-fz_i)-e^(-fz_t))","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"where beta is element slope angle [deg.], q is subsurface flow [mm^2/t], K_0 is the saturated hydraulic conductivity at the soil surface [mm/t], z_i is the water table depth [mm],z_t is total soil depth [mm], and f is a scaling parameter [mm^-1]:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"    f=fractheta_s-theta_rM","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"where theta_s is saturated water content [mm/mm] and theta_r is residual water content [mm/mm] and M represents a model parameter [mm], that determines the decrease of vertical saturated conductivity with depth.","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"Combining with the following continuity equation:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"    (theta_s-theta_r)fracpartial hpartial t = -wfracpartial qpartial x + wr","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"where h is the water table height [mm], x is the distance downslope [mm], and r is the netto input rate [mm/t] to the saturated store. Substituting for h (fracpartial qpartial h), gives:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"  w fracpartial qpartial t = -cwfracpartial qpartial x + cwr","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"where celerity c = fracK_0mathittan(beta)(theta_s-theta_r) e^(-fz_i)","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"The kinematic wave equation for lateral subsurface flow is solved iteratively using Newton's method.","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"note: Note\nFor the lateral subsurface flow kinematic wave the model timestep is not adjusted. For certain model timestep and model grid size combinations this may result in loss of accuracy.","category":"page"},{"location":"lateral/kinwave/#Limitations","page":"Kinematic wave","title":"Limitations","text":"","category":"section"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"The kinematic wave approach for channel, overland and lateral subsurface flow, assumes that the topography controls water flow mostly. This assumption holds for steep terrain, but in less steep terrain the hydraulic gradient is likely not equal to the surface slope (subsurface flow), or pressure differences and inertial momentum cannot be neglected (channel and overland flow). In addition, while the kinemative wave equations are solved with a nonlinear scheme using Newton's method (Chow, 1988), other model equations are solved through a simple explicit scheme. In summary the following limitations apply:","category":"page"},{"location":"lateral/kinwave/","page":"Kinematic wave","title":"Kinematic wave","text":"Channel flow, and to a lesser degree overland flow, may be unrealistic in terrain that is not steep, and where pressure forces and inertial momentum are important.\nThe lateral movement of subsurface flow may be very wrong in terrain that is not steep.","category":"page"},{"location":"structure/#Model-structure","page":"Model structure","title":"Model structure","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"struct Model{N,L,V,R,W}\n    config::Config  # all configuration options\n    network::N      # connectivity information, directed graph\n    lateral::L      # lateral model that holds lateral state, moves along network\n    vertical::V     # vertical model that holds vertical state, independent of each other\n    clock::Clock    # to keep track of simulation time\n    reader::R       # provides the model with dynamic input\n    writer::W       # writes model output\nend","category":"page"},{"location":"structure/#Config-and-TOML","page":"Model structure","title":"Config and TOML","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"TOML is used as the configuration format for models available in wflow. File paths included in the configuration TOML file are relative to the TOML file location. ","category":"page"},{"location":"structure/#General-time-info","page":"Model structure","title":"General time info","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"First information about time is provided in the TOML file, with an example below. A starttime, endtime and the model time step timestepsecs is required. The calendar and time_units optional information is used by the writer of the model, for model output in netCDF format.","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"casename = \"testcase\"                           # optional\n\ncalendar = \"proleptic_gregorian\"                # optional, this is default value\nendtime = 2000-02-01T00:00:00                   # required \nstarttime = 2000-01-01T00:00:00                 # required\ntime_units = \"days since 1900-01-01 00:00:00\"   # optional, this is default value\ntimestepsecs = 86400                            # required","category":"page"},{"location":"structure/#Model-section","page":"Model structure","title":"Model section","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"Model specific settings can be included in the model section of the TOML file.","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"[model]\ntype = \"sbm\"                        # one of (\"sbm\", \"sbm_gwf, \"hbv\")\nmasswasting = true                  # include lateral snow transport in the model, default is false\nsnow = true                         # include snow modelling, default is false\nreinit = true                       # cold (reinit = true) or warm state (reinit = false), default is true\nreservoirs = true                   # include reservoir modelling, default is false\nkin_wave_iteration = true           # enable kinematic wave iterations in the model, default is false\nthicknesslayers = [100, 300, 800]   # specific SBM setting: for each soil layer a thickness [mm] is specified","category":"page"},{"location":"structure/#State-section","page":"Model structure","title":"State section","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"The state section in the TOML file provides information about the location of the state file if the model is initialized with a warm state (path_input) and to what file the states are written at the end of the model run (path_output). A mapping between external state names and internal model states is required. This information is specified for each model component, the vertical model and lateral model components. In the example below the vertical component represents the SBM concept, and for the lateral components there is a river (including reservoir), land and subsurface domain. The internal model states are listed on the left side, and the external state names are listed on the right side.","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"[state]\npath_input = \"data/instates-moselle.nc\" \npath_output = \"data/outstates-moselle.nc\"\n\n[state.vertical]\nsatwaterdepth = \"satwaterdepth\"\nsnow = \"snow\"\ntsoil = \"tsoil\"\nustorelayerdepth = \"ustorelayerdepth\"\nsnowwater = \"snowwater\"\ncanopystorage = \"canopystorage\"\n\n[state.lateral.river]\nq = \"q_river\"\nh = \"h_river\"\nh_av = \"h_av_river\"\n\n[state.lateral.river.reservoir]\nvolume = \"volume_reservoir\"\n\n[state.lateral.subsurface]\nssf = \"ssf\"\n\n[state.lateral.land]\nq = \"q_land\"\nh = \"h_land\"\nh_av = \"h_av_land\"","category":"page"},{"location":"structure/#Input-section","page":"Model structure","title":"Input section","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"The input section of the TOML file contains information about the input forcing and model parameters files (netCDF format). Forcing is applied to the vertical component of the model, and needs to be mapped to the external netCDF variable name. forcing lists the internal model forcing parameters, and these are mapped to the external netCDF variables listed under the section [input.vertical]. It is possible to provide cyclic parameters to the model. In the example below this is done for the internal vertical.leaf_area_index model parameter, that is linked to the external netCDF variable \"LAI\" variable. ","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"As for the states, mapping of external model parameters (provided in the example below by the file staticmaps-moselle.nc) is done per model component. If a model parameter is not mapped a default value will be used if available.","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"[input]\npath_forcing = \"data/forcing-moselle.nc\"\npath_static = \"data/staticmaps-moselle.nc\"\n\n# these are not directly part of the model\ngauges = \"wflow_gauges\"\nldd = \"wflow_ldd\"\nriver_location = \"wflow_river\"\nsubcatchment = \"wflow_subcatch\"\n\n# specify the internal IDs of the parameters which vary over time\n# the external name mapping needs to be below together with the other mappings\nforcing = [\n\"vertical.precipitation\",\n\"vertical.temperature\",\n\"vertical.potential_evaporation\",\n]\n\ncyclic = [\"vertical.leaf_area_index\"]\n\n[input.vertical]\naltitude = \"wflow_dem\" \nc = \"c\" \ncf_soil = \"cf_soil\" \ncfmax = \"Cfmax\" \ne_r = \"EoverR\" \ninfiltcappath = \"InfiltCapPath\" \ninfiltcapsoil = \"InfiltCapSoil\" \nkext = \"Kext\" \n\"kv₀\" = \"KsatVer\" \nleaf_area_index = \"LAI\"\nm = \"M\" \nmaxleakage = \"MaxLeakage\" \npathfrac = \"PathFrac\" \npotential_evaporation = \"PET\" # forcing\nprecipitation = \"P\" # forcing\nrootdistpar = \"rootdistpar\" \nrootingdepth = \"RootingDepth\" \nsoilminthickness = \"SoilMinThickness\" \nsoilthickness = \"SoilThickness\" \nspecific_leaf = \"Sl\" \nstorage_wood = \"Swood\" \ntemperature = \"TEMP\" # forcing\ntt = \"TT\" \ntti = \"TTI\" \nttm = \"TTM\" \nw_soil = \"wflow_soil\" \nwater_holding_capacity = \"WHC\" \nwaterfrac = \"WaterFrac\" \n\"θᵣ\" = \"thetaR\" \n\"θₛ\" = \"thetaS\"\n\n[input.lateral.river]\nlength = \"wflow_riverlength\"\nn = \"N_River\"\nslope = \"RiverSlope\"\nwidth = \"wflow_riverwidth\"\n\n[input.lateral.river.reservoir]\narea = \"ResSimpleArea\"\nareas = \"wflow_reservoirareas\"\ndemand = \"ResDemand\"\nlocs = \"wflow_reservoirlocs\"\nmaxrelease = \"ResMaxRelease\"\nmaxvolume = \"ResMaxVolume\"\ntargetfullfrac = \"ResTargetFullFrac\"\ntargetminfrac = \"ResTargetMinFrac\"\n\n[input.lateral.subsurface]\nksathorfrac = \"KsatHorFrac\"\n\n[input.lateral.land]\nn = \"N\"\nslope = \"Slope\"","category":"page"},{"location":"structure/#Output-netCDF-section","page":"Model structure","title":"Output netCDF section","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"This section of the TOML file contains the output netCDF file for writing gridded model output, including a mapping between internal model parameter components and external netCDF variables.  ","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"[output]\npath = \"data/output_moselle.nc\"\n\n[output.vertical]\nsatwaterdepth = \"satwaterdepth\"\nsnow = \"snow\"\ntsoil = \"tsoil\"\nustorelayerdepth = \"ustorelayerdepth\"\nsnowwater = \"snowwater\"\ncanopystorage = \"canopystorage\"\n\n[output.lateral.river]\nq = \"q_river\"\nh = \"h_river\"\n\n[output.lateral.river.reservoir]\nvolume = \"volume_reservoir\"\n\n[output.lateral.subsurface]\nssf = \"ssf\"\n\n[output.lateral.land]\nq = \"q_land\"\nh = \"h_land\"","category":"page"},{"location":"structure/#Output-CSV-section","page":"Model structure","title":"Output CSV section","text":"","category":"section"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"Model output can also be written to CSV output. Below is an example that writes model output to the file \"output_moselle.csv\". For each CSV column a header and parameter (internal model parameter) is required. A reducer can be specified to apply to the model output, with the following available reducers:","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"maximum\nminimum\nmean\nmedian\nfirst\nlast\nonly","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"with only as the default. To extract data for a specific location (grid cell), the index of the vector, the coordinates coordinate.x and coordinate.y, or the x and y indices of the 2D array (index.x and index.y) can be provided. Finally a map can be provided to extract data for certain locations (e.g. gauges) or areas (e.g. subcatchment).","category":"page"},{"location":"structure/","page":"Model structure","title":"Model structure","text":"[csv]\npath = \"data/output_moselle.csv\"\n\n[[csv.column]]\nheader = \"Q\"\nparameter = \"lateral.river.q\"\nreducer = \"maximum\"\n\n[[csv.column]]\nheader = \"volume\"\nindex = 1\nparameter = \"lateral.river.reservoir.volume\"\n\n[[csv.column]]\ncoordinate.x = 6.255\ncoordinate.y = 50.012\nheader = \"temp_bycoord\"\nparameter = \"vertical.temperature\"\n\n[[csv.column]]\nheader = \"temp_byindex\"\nindex.x = 100\nindex.y = 50\nparameter = \"vertical.temperature\"\n\n[[csv.column]]\nheader = \"Q\"\nmap = \"gauges\"\nparameter = \"lateral.river.q\"\n\n[[csv.column]]\nheader = \"recharge\"\nmap = \"subcatchment\"\nparameter = \"vertical.recharge\"\nreducer = \"mean\"","category":"page"},{"location":"","page":"Home","title":"Home","text":"CurrentModule = Wflow","category":"page"},{"location":"#Wflow","page":"Home","title":"Wflow","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Wflow is a Julia package that provides a hydrological modeling framework, as well as several different vertical and lateral concepts that can be used to run hydrological simulations.","category":"page"},{"location":"","page":"Home","title":"Home","text":"This is an in development version of wflow, a continuation of the work available here. We will make a first release later this year.","category":"page"},{"location":"","page":"Home","title":"Home","text":"See the side bar on the left to navigate to other sections of the documentation.","category":"page"}]
}
